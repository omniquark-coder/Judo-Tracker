<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Judo Mastery v4.0</title>
    <style>
        :root { --primary: #003366; --bg: #f4f6f8; --card: #ffffff; --text: #2c3e50; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; padding-bottom: 80px; }
        
        /* Sticky Header */
        .controls-area { position: sticky; top: 0; background: var(--bg); z-index: 1000; padding: 10px 0; border-bottom: 1px solid #ddd; }
        .control-row { display: flex; gap: 8px; margin-bottom: 8px; }
        select, input { padding: 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; background: white; flex-grow: 1; }
        .btn-icon { width: 44px; cursor: pointer; background: white; border: 1px solid #ccc; border-radius: 8px; font-size: 20px; }
        
        /* Progress Card */
        .stats-card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .progress-container { background: #e9ecef; height: 10px; border-radius: 5px; margin-top: 8px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s; }

        /* Syllabus Layout */
        .belt-section { margin-bottom: 30px; border-radius: 10px; overflow: hidden; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .belt-header { padding: 15px; font-weight: 800; text-transform: uppercase; color: white; display: flex; justify-content: space-between; align-items: center; }
        
        /* Belt Themes */
        .theme-white { background: #bdc3c7; color: #444; border: 1px solid #999; }
        .theme-yellow { background: #f1c40f; color: #444; }
        .theme-orange { background: #e67e22; }
        .theme-green { background: #27ae60; }
        .theme-blue { background: #0055A4; }
        .theme-brown { background: #5d4037; }

        .category-header { background: #f8f9fa; padding: 8px 15px; font-size: 0.85em; font-weight: bold; color: #7f8c8d; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #eee; margin-top: 0; }

        /* Technique Items */
        .tech-item { border-bottom: 1px solid #eee; padding: 0; transition: background 0.2s; }
        .tech-item.mastered { opacity: 0.5; background: #fafafa; }
        .tech-head { padding: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .tech-name { font-weight: 600; font-size: 1.05em; }
        
        .score-badge { font-weight: bold; font-size: 0.9em; padding: 4px 8px; border-radius: 6px; min-width: 30px; text-align: center; }
        .s-0 { background: #eee; color: #999; }
        .s-low { background: #fadbd8; color: #c0392b; }
        .s-mid { background: #fcf3cf; color: #f39c12; }
        .s-high { background: #d5f5e3; color: #27ae60; }

        /* Details Panel */
        .tech-details { padding: 0 15px 15px; display: none; background: #fcfcfc; }
        .tech-details.open { display: block; }
        .slider-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; color: #555; margin-bottom: 12px; }
        input[type=range] { margin: 0 15px; flex-grow: 1; }
        
        .vid-btn { display: block; width: 100%; text-align: center; background: #c4302b; color: white; padding: 10px; border-radius: 6px; text-decoration: none; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

<div class="controls-area">
    <div class="control-row">
        <select id="userSelect" onchange="app.switchUser()">
            <option value="eric">√âric (Blue Belt)</option>
            <option value="vincent">Vincent (Green-Orange)</option>
            <option value="olivier">Olivier (Yellow-White)</option>
        </select>
        <button class="btn-icon" onclick="app.clearData()" title="Clear Data">üóëÔ∏è</button>
        <button class="btn-icon" onclick="app.exportData()" title="Save">üíæ</button>
    </div>
    <input type="text" id="search" placeholder="Search technique..." onkeyup="app.render()">
</div>

<div class="stats-card">
    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
        <span style="font-weight:bold; color:var(--primary)">Belt Progress</span>
        <span id="progressText">0%</span>
    </div>
    <div class="progress-container">
        <div id="progressBar" class="progress-bar"></div>
    </div>
    <div id="focusMsg" style="margin-top:10px; font-size:0.9em; color:#666; font-style:italic;"></div>
</div>

<div id="appContainer"></div>

<script>
// --- SYLLABUS DATA (Sources: Judo Canada Kyu Syllabus 2021) ---
const syllabus = [
    { 
        id: "white-yellow", belt: "White to Yellow (5th Kyu)", theme: "theme-white",
        sections: [
            { title: "Tachi-waza (Throws)", list: [
                "Tsuri-goshi", "Uki-goshi", "O-goshi", "Ko-soto-gari", "Ko-soto-gake", 
                "Hiza-guruma", "Uki-otoshi", "Tai-otoshi", "O-uchi-gari", 
                "O-soto-otoshi", "Ko-uchi-gari"
            ]},
            { title: "Ne-waza (Ground)", list: [
                "Kesa-gatame", "Kuzure-kesa-gatame", "Yoko-shiho-gatame", 
                "Kata-gatame", "Kami-shiho-gatame"
            ]}
        ]
    },
    { 
        id: "yellow-orange", belt: "Yellow to Orange (4th Kyu)", theme: "theme-yellow",
        sections: [
            { title: "Tachi-waza (Throws)", list: [
                "Ippon-seoi-nage", "Seoi-nage", "Eri-seoi-nage", "De-ashi-harai", 
                "Sasae-tsurikomi-ashi", "O-soto-gari", "Tsurikomi-goshi", "Okuri-ashi-harai"
            ]},
            { title: "Ne-waza (Ground)", list: [
                "Kuzure-kami-shiho-gatame", "Ushiro-kesa-gatame", "Tate-shiho-gatame", 
                "Uki-gatame", "Ura-gatame"
            ]}
        ]
    },
    { 
        id: "orange-green", belt: "Orange to Green (3rd Kyu)", theme: "theme-orange",
        sections: [
            { title: "Tachi-waza (Throws)", list: [
                "Harai-goshi", "Tani-otoshi", "Sode-tsurikomi-goshi", "Yoko-tomoe-nage", 
                "Yoko-otoshi", "Harai-tsurikomi-ashi", "Sumi-gaeshi", "Tomoe-nage"
            ]},
            { title: "Ne-waza (Ground)", list: [
                "Sankaku-gatame (Osae)", "Nami-juji-jime", "Gyaku-juji-jime", 
                "Kata-juji-jime", "Ude-garami", "Juji-gatame", "Ude-gatame"
            ]}
        ]
    },
    { 
        id: "green-blue", belt: "Green to Blue (2nd Kyu)", theme: "theme-green",
        sections: [
            { title: "Tachi-waza (Throws)", list: [
                "Hane-goshi", "Ushiro-goshi", "Obi-tori-gaeshi", "Seoi-otoshi", "Uchi-mata", 
                "Hane-goshi-gaeshi", "Ko-uchi-gaeshi", "Uchi-mata-gaeshi"
            ]},
            { title: "Ne-waza (Ground)", list: [
                "Hadaka-jime", "Okuri-eri-jime", "Kataha-jime", "Hiza-gatame", 
                "Waki-gatame", "Hara-gatame", "Katate-jime"
            ]}
        ]
    },
    { 
        id: "blue-brown", belt: "Blue to Brown (1st Kyu)", theme: "theme-blue",
        sections: [
            { title: "Tachi-waza (Throws)", list: [
                "Koshi-guruma", "Harai-makikomi", "O-soto-makikomi", "Sumi-otoshi", 
                "Ura-nage", "Yoko-guruma", "Ko-uchi-makikomi", "Yoko-wakare"
            ]},
            { title: "Ne-waza (Ground)", list: [
                "Ryote-jime", "Ashi-gatame", "Sode-guruma-jime", "Te-gatame", 
                "Tsukkomi-jime", "Sankaku-gatame (Kansetsu)", "Sankaku-jime"
            ]}
        ]
    }
];

const app = {
    user: "eric",
    data: {},

    init() {
        // Migration to V4 key to avoid conflicts
        const stored = localStorage.getItem("judoTrackerV4");
        this.data = stored ? JSON.parse(stored) : { "eric": {}, "vincent": {}, "olivier": {} };
        this.render();
    },

    switchUser() {
        this.user = document.getElementById("userSelect").value;
        this.render();
    },

    getScore(techName) {
        const t = this.data[this.user][techName];
        if (!t) return 0;
        // Average of 4 metrics
        const avg = (parseInt(t.migi||0) + parseInt(t.hidari||0) + parseInt(t.kuzushi||0) + parseInt(t.trans||0)) / 4;
        return parseFloat(avg.toFixed(1));
    },

    setVal(techName, aspect, val) {
        if (!this.data[this.user][techName]) this.data[this.user][techName] = {};
        this.data[this.user][techName][aspect] = val;
        
        // Live update UI
        document.getElementById(`val-${techName}-${aspect}`).innerText = val;
        const newScore = this.getScore(techName);
        const badge = document.getElementById(`badge-${techName}`);
        badge.innerText = newScore;
        badge.className = `score-badge ${this.getBadgeClass(newScore)}`;
        
        this.save();
        this.updateStats();
    },

    save() {
        localStorage.setItem("judoTrackerV4", JSON.stringify(this.data));
    },

    getBadgeClass(score) {
        if (score === 0) return "s-0";
        if (score < 3) return "s-low";
        if (score < 4.5) return "s-mid";
        return "s-high";
    },

    toggleDetails(id) {
        // Close others
        document.querySelectorAll('.tech-details').forEach(el => {
            if (el.id !== id) el.classList.remove('open');
        });
        document.getElementById(id).classList.toggle('open');
    },

    clearData() {
        if(confirm("Reset all scores for all users?")) {
            localStorage.removeItem("judoTrackerV4");
            location.reload();
        }
    },

    exportData() {
        const str = JSON.stringify(this.data);
        const blob = new Blob([str], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "judo_backup.json";
        a.click();
    },

    updateStats() {
        let total = 0, max = 0;
        let weakTech = null;
        
        syllabus.forEach(level => {
            level.sections.forEach(sec => {
                sec.list.forEach(techName => {
                    max += 20; // 4 aspects * 5
                    const score = this.getScore(techName);
                    total += (score * 4);
                    if (score < 3 && !weakTech) weakTech = techName;
                });
            });
        });

        const pct = Math.round((total/max)*100);
        document.getElementById("progressBar").style.width = pct + "%";
        document.getElementById("progressText").innerText = pct + "%";
        document.getElementById("focusMsg").innerHTML = weakTech 
            ? `Next Priority: <strong>${weakTech}</strong>` 
            : "Great job! Curriculum mastered.";
    },

    render() {
        const container = document.getElementById("appContainer");
        const search = document.getElementById("search").value.toLowerCase();
        container.innerHTML = "";

        syllabus.forEach(level => {
            // Filter Logic
            let hasMatch = false;
            let levelHtml = "";
            
            level.sections.forEach(section => {
                // Sort: Unmastered (Score < 4) first, Mastered last
                let sortedList = [...section.list].sort((a,b) => {
                    const sA = this.getScore(a);
                    const sB = this.getScore(b);
                    // If both mastered or both unmastered, sort alpha, else unmastered first
                    if ((sA >= 4 && sB >= 4) || (sA < 4 && sB < 4)) return 0;
                    return sA - sB; 
                });

                let sectionHtml = "";
                let visibleCount = 0;

                sortedList.forEach(techName => {
                    if (!techName.toLowerCase().includes(search)) return;
                    
                    hasMatch = true;
                    visibleCount++;
                    const techId = techName.replace(/[^a-zA-Z0-9]/g, '');
                    const d = this.data[this.user][techName] || {};
                    const score = this.getScore(techName);
                    const masteredClass = score >= 4 ? "mastered" : "";
                    const videoLink = `https://www.youtube.com/results?search_query=judo+${techName.replace(/\s/g, '+')}+tutorial`;

                    sectionHtml += `
                    <div class="tech-item ${masteredClass}">
                        <div class="tech-head" onclick="app.toggleDetails('d-${techId}')">
                            <span class="tech-name">${techName}</span>
                            <span id="badge-${techName}" class="score-badge ${this.getBadgeClass(score)}">${score}</span>
                        </div>
                        <div id="d-${techId}" class="tech-details">
                            ${this.renderSlider(techName, 'migi', 'Right (Migi)', d.migi)}
                            ${this.renderSlider(techName, 'hidari', 'Left (Hidari)', d.hidari)}
                            ${this.renderSlider(techName, 'kuzushi', 'Kuzushi', d.kuzushi)}
                            ${this.renderSlider(techName, 'trans', 'Transition', d.trans)}
                            <a href="${videoLink}" target="_blank" class="vid-btn">‚ñ∂ Watch Tutorial</a>
                        </div>
                    </div>`;
                });

                if (visibleCount > 0) {
                    levelHtml += `<div class="category-header">${section.title}</div>${sectionHtml}`;
                }
            });

            if (hasMatch) {
                const beltBlock = document.createElement("div");
                beltBlock.className = "belt-section";
                beltBlock.innerHTML = `
                    <div class="belt-header ${level.theme}">
                        <span>${level.belt}</span>
                    </div>
                    ${levelHtml}
                `;
                container.appendChild(beltBlock);
            }
        });
        this.updateStats();
    },

    renderSlider(tech, key, label, val = 0) {
        return `
        <div class="slider-row">
            <span style="width:90px;">${label}</span>
            <input type="range" min="0" max="5" value="${val}" oninput="app.setVal('${tech}', '${key}', this.value)">
            <span id="val-${tech}-${key}" style="width:15px; font-weight:bold; text-align:right;">${val}</span>
        </div>`;
    }
};

app.init();
</script>

</body>
</html>
